name: Build Simple Android APK

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
    
    - name: Remove problematic dependencies
      run: |
        cd android
        # Remove Capacitor references from settings.gradle
        sed -i '/capacitor/d' settings.gradle
        # Remove Capacitor from app build.gradle
        sed -i '/capacitor/d' app/build.gradle
        # Remove AdMob dependencies temporarily
        sed -i '/admob/d' app/build.gradle
        sed -i '/firebase/d' app/build.gradle
    
    - name: Create minimal build.gradle
      run: |
        cat > android/app/build.gradle << 'EOF'
        plugins {
            id 'com.android.application'
        }

        android {
            namespace 'com.diabetesquiz.app'
            compileSdk 34

            defaultConfig {
                applicationId "com.diabetesquiz.app"
                minSdk 22
                targetSdk 34
                versionCode 1
                versionName "1.0"
            }

            buildTypes {
                release {
                    minifyEnabled false
                    proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
                }
            }
            compileOptions {
                sourceCompatibility JavaVersion.VERSION_1_8
                targetCompatibility JavaVersion.VERSION_1_8
            }
        }

        dependencies {
            implementation 'androidx.appcompat:appcompat:1.6.1'
        }
        EOF
    
    - name: Create keystore
      run: |
        cd android
        keytool -genkey -v -keystore app-release-key.keystore -alias my-key-alias -keyalg RSA -keysize 2048 -validity 10000 -storepass password -keypass password -dname "CN=DiabetesQuiz, OU=Mobile, O=Health, L=Seoul, C=KR"
    
    - name: Make gradlew executable
      run: chmod +x android/gradlew
    
    - name: Build APK
      run: |
        cd android
        ./gradlew clean
        ./gradlew assembleRelease
    
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: diabetes-quiz-apk
        path: android/app/build/outputs/apk/release/app-release.apk
